<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deployment/部署 | 鲁班H5 文档</title>
    <meta name="description" content="前后端均开源的H5制作平台，类似易企秀、百度H5、Maka、人人秀.">
    <link rel="icon" href="/luban-h5/luban-logo.png">
  <meta name="theme-color" content="#2F80ED">
  <meta prefix="og: http://ogp.me/ns#" property="og:title" content="鲁班H5 文档">
  <meta prefix="og: http://ogp.me/ns#" property="twitter:title" content="鲁班H5 文档">
  <meta prefix="og: http://ogp.me/ns#" property="og:type" content="article">
  <meta prefix="og: http://ogp.me/ns#" property="og:url" content="http://docs.huban-h5.surge.sh/">
  <meta prefix="og: http://ogp.me/ns#" property="og:description" content="前后端均开源的H5制作平台，类似易企秀、百度H5、Maka、人人秀.">
  <meta prefix="og: http://ogp.me/ns#" property="og:image" content="http://docs.huban-h5.surge.sh/luban-logo.png">
  <meta prefix="og: http://ogp.me/ns#" property="og:article:author" content="ly525">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="msapplication-TileImage" content="/luban-logo.png">
  <meta name="msapplication-TileColor" content="#2F80ED">
  <script src="/luban-h5/yandex.js"></script>
    
    <link rel="preload" href="/luban-h5/assets/css/0.styles.e1c8f966.css" as="style"><link rel="preload" href="/luban-h5/assets/js/app.6a945241.js" as="script"><link rel="preload" href="/luban-h5/assets/js/2.d52d92c6.js" as="script"><link rel="preload" href="/luban-h5/assets/js/8.c0577a36.js" as="script"><link rel="prefetch" href="/luban-h5/assets/js/10.66a85b48.js"><link rel="prefetch" href="/luban-h5/assets/js/11.e7b36bfa.js"><link rel="prefetch" href="/luban-h5/assets/js/12.badfc507.js"><link rel="prefetch" href="/luban-h5/assets/js/13.89bce1c5.js"><link rel="prefetch" href="/luban-h5/assets/js/14.d4c5fde0.js"><link rel="prefetch" href="/luban-h5/assets/js/15.0bd29c85.js"><link rel="prefetch" href="/luban-h5/assets/js/16.b4d62751.js"><link rel="prefetch" href="/luban-h5/assets/js/17.aba96acb.js"><link rel="prefetch" href="/luban-h5/assets/js/3.fc2f44e7.js"><link rel="prefetch" href="/luban-h5/assets/js/4.3998b889.js"><link rel="prefetch" href="/luban-h5/assets/js/5.186b73cd.js"><link rel="prefetch" href="/luban-h5/assets/js/6.2d676122.js"><link rel="prefetch" href="/luban-h5/assets/js/7.d85a49bb.js"><link rel="prefetch" href="/luban-h5/assets/js/9.619b2dbf.js">
    <link rel="stylesheet" href="/luban-h5/assets/css/0.styles.e1c8f966.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/luban-h5/" class="home-link router-link-active"><!----> <span class="site-name">鲁班H5 文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://www.yuque.com/liuyan-ew1qk/oh5d0n?language=en-us" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Document(En)
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://ly525.github.io/luban-h5" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/ly525/luban-h5" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://www.yuque.com/liuyan-ew1qk/oh5d0n?language=en-us" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Document(En)
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://ly525.github.io/luban-h5" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/ly525/luban-h5" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>🚀 Getting started</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/luban-h5/zh/getting-started/introduction.html" class="sidebar-link">简介</a></li><li><a href="/luban-h5/zh/getting-started/features.html" class="sidebar-link">Features</a></li><li><a href="/luban-h5/zh/getting-started/quick-start.html" class="sidebar-link">快速开始</a></li><li><a href="/luban-h5/zh/getting-started/code-structure.html" class="sidebar-link">代码目录说明</a></li><li><a href="/luban-h5/zh/getting-started/deployment.html" class="active sidebar-link">Deployment/部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/luban-h5/zh/getting-started/deployment.html#阿里云-腾讯云-digital-ocean" class="sidebar-link">阿里云/腾讯云/Digital Ocean</a></li><li class="sidebar-sub-header"><a href="/luban-h5/zh/getting-started/deployment.html#docker-部署" class="sidebar-link">Docker 部署</a></li><li class="sidebar-sub-header"><a href="/luban-h5/zh/getting-started/deployment.html#heroku" class="sidebar-link">Heroku</a></li></ul></li><li><a href="/luban-h5/zh/getting-started/feedback.html" class="sidebar-link">Feedback/意见反馈</a></li><li><a href="/luban-h5/zh/getting-started/qa.html" class="sidebar-link">QA/常见问题答疑</a></li><li><a href="/luban-h5/zh/getting-started/discussion.html" class="sidebar-link">交流群</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>💡 实现思路</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>🔌 Local plugins</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="deployment-部署"><a href="#deployment-部署" aria-hidden="true" class="header-anchor">#</a> Deployment/部署</h1> <h2 id="阿里云-腾讯云-digital-ocean"><a href="#阿里云-腾讯云-digital-ocean" aria-hidden="true" class="header-anchor">#</a> 阿里云/腾讯云/Digital Ocean</h2> <h4 id="云服务器-centos"><a href="#云服务器-centos" aria-hidden="true" class="header-anchor">#</a> 云服务器(centos)</h4> <p>首先需要安装一些基础的软件包，请自行安装（具体参照其官网文档）</p> <ul><li>node</li> <li>npm</li> <li>nginx</li> <li>yarn</li> <li>pm2</li></ul> <p>以下脚本仅供参考</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># install yarn</span>
<span class="token function">curl</span> --silent --location https://dl.yarnpkg.com/rpm/yarn.repo <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/yum.repos.d/yarn.repo
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token function">yarn</span> -y

<span class="token comment"># install nginx</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> nginx -y
<span class="token comment"># install pm2</span>
<span class="token function">npm</span> <span class="token function">install</span> pm2 -g
<span class="token comment"># pm2 examples</span>
<span class="token comment"># pm2 start server.js</span>
<span class="token comment"># pm2 stop server</span>
<span class="token comment"># pm2 restart server</span>
<span class="token comment"># pm2 stop all</span>

</code></pre></div><p>nginx 配置文件 demo</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">server</span> <span class="token punctuation">{</span>
  <span class="token keyword">listen</span> <span class="token number">443</span><span class="token punctuation">;</span>
  <span class="token keyword">server_name</span> your_domain<span class="token punctuation">;</span>

  <span class="token keyword">client_body_buffer_size</span> <span class="token number">20</span>M<span class="token punctuation">;</span>
  <span class="token keyword">client_max_body_size</span> <span class="token number">20</span>M<span class="token punctuation">;</span>
  <span class="token keyword">proxy_buffer_size</span> <span class="token number">20</span>M<span class="token punctuation">;</span>
  <span class="token keyword">proxy_buffers</span> <span class="token number">32</span> <span class="token number">20</span>M<span class="token punctuation">;</span>
  <span class="token keyword">proxy_busy_buffers_size</span> <span class="token number">20</span>M<span class="token punctuation">;</span>

  <span class="token keyword">ssl</span> on<span class="token punctuation">;</span>
  <span class="token keyword">ssl_certificate</span> cert<span class="token operator">/</span>luban<span class="token operator">-</span>api<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>
  <span class="token keyword">ssl_certificate_key</span> cert<span class="token operator">/</span>luban<span class="token operator">-</span>api<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token keyword">ssl_session_timeout</span> <span class="token number">5</span>s<span class="token punctuation">;</span>
  <span class="token keyword">ssl_ciphers</span> ECDHE<span class="token operator">-</span>RSA<span class="token operator">-</span>AES128<span class="token operator">-</span>GCM<span class="token operator">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">:</span>ECDH<span class="token punctuation">:</span>AES<span class="token punctuation">:</span>HIGH<span class="token punctuation">:</span><span class="token operator">!</span>NULL<span class="token punctuation">:</span><span class="token operator">!</span>aNULL<span class="token punctuation">:</span><span class="token operator">!</span>MD5<span class="token punctuation">:</span><span class="token operator">!</span>ADH<span class="token punctuation">:</span><span class="token operator">!</span>RC4<span class="token punctuation">;</span>
  <span class="token keyword">ssl_protocols</span> TLSv1 TLSv1<span class="token punctuation">.</span><span class="token number">1</span> TLSv1<span class="token punctuation">.</span><span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token keyword">ssl_prefer_server_ciphers</span> on<span class="token punctuation">;</span>

  <span class="token keyword">gzip</span> on<span class="token punctuation">;</span>
  <span class="token keyword">gzip_min_length</span> <span class="token number">1</span>k<span class="token punctuation">;</span>
  <span class="token keyword">gzip_buffers</span> <span class="token number">4</span> <span class="token number">16</span>k<span class="token punctuation">;</span>
  <span class="token keyword">gzip_disable</span> <span class="token string">&quot;MSIE [1-6]\.&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">gzip_comp_level</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">gzip_types</span> image<span class="token operator">/</span>png application<span class="token operator">/</span>json text<span class="token operator">/</span>plain application<span class="token operator">/</span>x<span class="token operator">-</span>javascript text<span class="token operator">/</span>css application<span class="token operator">/</span>xml text<span class="token operator">/</span>javascript application<span class="token operator">/</span>javascript<span class="token punctuation">;</span>

  <span class="token comment"># TODO 这边的 psd-files、engine-assets、third-libs 开发的时候，可以走 proxy_pass</span>
  <span class="token comment"># 生产环境的时候，最好走另外的 location，直接让 nginx 访问静态文件</span>
  <span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">(</span>upload<span class="token operator">|</span>content<span class="token operator">-</span>manager<span class="token operator">|</span>users<span class="token operator">-</span>permissions<span class="token operator">|</span>works<span class="token operator">|</span>admin<span class="token operator">|</span>psd<span class="token operator">-</span>files<span class="token operator">|</span>workforms<span class="token operator">|</span>third<span class="token operator">-</span>libs<span class="token operator">|</span>engine<span class="token operator">-</span>assets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Real<span class="token operator">-</span>IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">1337</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>

    <span class="token keyword">root</span> <span class="token operator">/</span>home<span class="token operator">/</span>centos<span class="token operator">/</span>codebase<span class="token operator">/</span>luban<span class="token operator">/</span>luban<span class="token operator">-</span>h5<span class="token operator">-</span>dist<span class="token operator">/</span>front<span class="token operator">-</span>end<span class="token operator">/</span><span class="token punctuation">;</span>
    <span class="token comment">#try_files $uri $uri/ /index.html;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="本地执行："><a href="#本地执行：" aria-hidden="true" class="header-anchor">#</a> 本地执行：</h4> <p>请先提前调研：flightplan
在项目根目录作如下操作：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> flightplan // 部署脚本，官方链接
<span class="token function">npm</span> run deploy:esc // 云服务器 <span class="token punctuation">(</span>Elastic Compute Service, 简称 ECS<span class="token punctuation">)</span>
</code></pre></div><p>本地部署脚本</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> os <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> plan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'flightplan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// configuration</span>
local_dist_dir <span class="token operator">=</span> <span class="token string">'./'</span><span class="token punctuation">;</span> <span class="token comment">// root path for luban-h5</span>
remote_project_dir <span class="token operator">=</span> <span class="token string">'~/codebase/luban/luban-h5'</span><span class="token punctuation">;</span> <span class="token comment">// root path for luban-h5 on server</span>
remote_project_api_dir <span class="token operator">=</span> <span class="token string">'~/codebase/luban/luban-h5/back-end/h5-api'</span><span class="token punctuation">;</span> <span class="token comment">// api root path for luban-h5 on server</span>

<span class="token comment">// production server config</span>
plan<span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span><span class="token string">'production'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  host<span class="token punctuation">:</span> <span class="token string">'your host ip'</span><span class="token punctuation">,</span> <span class="token comment">// your server ip</span>
  username<span class="token punctuation">:</span> <span class="token string">'centos'</span><span class="token punctuation">,</span> <span class="token comment">// your server username</span>
  <span class="token comment">// 更新为绝对路径</span>
  privateKey<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>os<span class="token punctuation">.</span>homedir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/.ssh/id_rsa</span><span class="token template-punctuation string">`</span></span> <span class="token comment">// your privateKey to rsync files</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 1. setup folders
 * 2. sync files
 * 3. install dependencies
 * 4. (re)start api service
 * 5. soft link nginx conf
 *
 * 1. 创建同步文件件
 * 2. 同步本地在 git 中的文件（你也可以在服务器端git clone）
 * 3. 在 h5-api 目录安装依赖
 * 4. 使用pm2 重启服务
 * 5. 给 nginx 文件做一个软件链接
 *
 */</span>

<span class="token comment">// init remove server path</span>
<span class="token comment">// 在第一步的时候，需要打开这一项：初始化服务器，现在还不完整，需要补充</span>
<span class="token comment">// plan.remote(remote =&gt; {</span>
<span class="token comment">//   // remove.exec(`mkdir -p ${remote_project_dir}`)</span>
<span class="token comment">//   remove.sudo(`yum install nginx -y`)</span>
<span class="token comment">//   remote.with(`mkdir -p ${remote_project_dir}`, () =&gt; {</span>
<span class="token comment">//     // remote.log('Install dependencies');</span>
<span class="token comment">//     // remote.exec('yarn');</span>
<span class="token comment">//     remote.exec('pwd');</span>
<span class="token comment">//   });</span>
<span class="token comment">// });</span>


<span class="token comment">// run commands on localhost</span>
plan<span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token parameter">local</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// local.log('=&gt; Run build');</span>
  <span class="token comment">// local.exec('npm run build');</span>
  <span class="token comment">// local.log('=&gt; Build finish');</span>

  local<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'=&gt; Copy files to remote hosts'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// TODO reference: https://github.com/pstadler/flightplan/issues/142</span>
  local<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cd </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>local_dist_dir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// const filesToCopy = local.exec('find . -type f', { silent: true })</span>
    <span class="token keyword">const</span> filesToCopy <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">git</span><span class="token punctuation">(</span><span class="token string">'ls-files'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>silent<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// get list of files under version control</span>

    local<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>filesToCopy<span class="token punctuation">,</span> remote_project_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    local<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'=&gt; Copy finish'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// run commands on the target's remote hosts</span>
plan<span class="token punctuation">.</span><span class="token function">remote</span><span class="token punctuation">(</span><span class="token parameter">remote</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  remote<span class="token punctuation">.</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cd </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>remote_project_api_dir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    remote<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Install dependencies'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    remote<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'yarn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    remote<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'pm2 restart server'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre></div><h4 id="中间可能遇到的一些问题："><a href="#中间可能遇到的一些问题：" aria-hidden="true" class="header-anchor">#</a> 中间可能遇到的一些问题：</h4> <ol><li><code>Cannot parse privateKey: Unsupported key format</code> 
解决方案请参照：<a href="https://stackoverflow.com/questions/53400628/cannot-parse-privatekey-unsupported-key-format" target="_blank" rel="noopener noreferrer">Cannot parse privateKey: Unsupported key format<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol> <h2 id="docker-部署"><a href="#docker-部署" aria-hidden="true" class="header-anchor">#</a> Docker 部署</h2> <blockquote><p>以下方案来自：<a href="https://github.com/yi-ge/luban-h5#docker-%E9%83%A8%E7%BD%B2" target="_blank" rel="noopener noreferrer">https://github.com/yi-ge/luban-h5#docker-%E9%83%A8%E7%BD%B2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，非常非常感谢。
但仅供参考，此方案不是鲁班的官方的解决方案</p> <p>鲁班决定暂时不按照这种方案来做，可以先使用上面部署脚本来发布到服务器上，进行部署。
鲁班后期考虑出一个简单版本docker image的部署方案，直接拉镜像，在服务器端就能直接跑起来。</p></blockquote> <p>请确保您的<code>80</code>端口和<code>443</code>端口均打开，如果已经配置了其它项目，请进行手工调整。</p> <ol><li>修改<code>yourdomain.tld</code>为您的前端域名并解析到服务器。</li> <li>修改<code>api.yourdomain.tld</code>为您的后端域名并解析到服务器。</li> <li>依次执行以下命令。</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Clone luban-h5</span>
<span class="token function">git</span> clone https://github.com/ly525/luban-h5.git
<span class="token builtin class-name">cd</span> luban-h5

<span class="token comment"># Install require package</span>
docker run --rm -v <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>:/root -w /root/back-end/h5-api node:12.8.1 <span class="token function">bash</span> -c <span class="token string">&quot;yarn &amp;&amp; NODE_ENV=production yarn build&quot;</span>

docker run --rm -v <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>:/root -w /root/front-end/h5 <span class="token punctuation">\</span>
    --env <span class="token string">&quot;PUBLIC_PATH=/&quot;</span> <span class="token punctuation">\</span>
    --env <span class="token string">&quot;PROD_API_ORIGIN=api.yourdomain.tld&quot;</span> <span class="token punctuation">\</span>
    node:12.8.1 <span class="token function">bash</span> -c <span class="token string">&quot;yarn &amp;&amp; NODE_ENV=production yarn build &amp;&amp; node build/engine.webpack.js&quot;</span>

<span class="token comment"># Start back-end</span>
docker run --detach <span class="token punctuation">\</span>
    --name nginx-proxy <span class="token punctuation">\</span>
    --publish <span class="token number">80</span>:80 <span class="token punctuation">\</span>
    --publish <span class="token number">443</span>:443 <span class="token punctuation">\</span>
    --volume /etc/nginx/certs <span class="token punctuation">\</span>
    --volume /etc/nginx/vhost.d <span class="token punctuation">\</span>
    --volume /usr/share/nginx/html <span class="token punctuation">\</span>
    --volume /var/run/docker.sock:/tmp/docker.sock:ro <span class="token punctuation">\</span>
    jwilder/nginx-proxy

docker run --detach <span class="token punctuation">\</span>
    --name nginx-proxy-letsencrypt <span class="token punctuation">\</span>
    --volumes-from nginx-proxy <span class="token punctuation">\</span>
    --volume /var/run/docker.sock:/var/run/docker.sock:ro <span class="token punctuation">\</span>
    jrcs/letsencrypt-nginx-proxy-companion

docker run -itd -m 512m <span class="token punctuation">\</span>
    --restart<span class="token operator">=</span>always <span class="token punctuation">\</span>
    --name luban-h5-front <span class="token punctuation">\</span>
    -v <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>/front-end/h5/dist:/usr/share/nginx/html <span class="token punctuation">\</span>
    --env <span class="token string">&quot;NODE_ENV=production&quot;</span> <span class="token punctuation">\</span>
    --env <span class="token string">&quot;VIRTUAL_HOST=yourdomain.tld&quot;</span> <span class="token punctuation">\</span>
    --env <span class="token string">&quot;LETSENCRYPT_HOST=yourdomain.tld&quot;</span> <span class="token punctuation">\</span>
    --env <span class="token string">&quot;PROD_API_ORIGIN=api.yourdomain.tld&quot;</span> <span class="token punctuation">\</span>
    nginx

<span class="token comment"># Start font-end</span>
docker run -itd -m 1024m <span class="token punctuation">\</span>
    --name luban-h5-api <span class="token punctuation">\</span>
    --restart<span class="token operator">=</span>always <span class="token punctuation">\</span>
    -v <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>:/root -w /root/back-end/h5-api <span class="token punctuation">\</span>
    -p <span class="token number">1337</span>:1337 <span class="token punctuation">\</span>
    --env <span class="token string">&quot;NODE_ENV=production&quot;</span> <span class="token punctuation">\</span>
    --env <span class="token string">&quot;VIRTUAL_PORT=1337&quot;</span> <span class="token punctuation">\</span>
    --env <span class="token string">&quot;VIRTUAL_HOST=api.yourdomain.tld&quot;</span> <span class="token punctuation">\</span>
    --env <span class="token string">&quot;LETSENCRYPT_HOST=api.yourdomain.tld&quot;</span> <span class="token punctuation">\</span>
   --restart<span class="token operator">=</span>always node:12.8.1 <span class="token punctuation">\</span>
   <span class="token function">yarn</span> start
</code></pre></div><p>稍等片刻，访问<code>https://你的域名</code>，部署完成。</p> <p>关于Nginx、SSL的配置，可以参考：<a href="https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion" target="_blank" rel="noopener noreferrer">https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <hr> <p>docker 自我学习，请忽略</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker --rm
	相当于：
	<span class="token number">1</span>. docker run hello-world<span class="token punctuation">(</span>hello-world为image-name<span class="token punctuation">)</span>
	<span class="token number">2</span>. docker <span class="token function">rm</span> hello-world-container-id<span class="token punctuation">(</span>通过 docker <span class="token function">ps</span> -a 查看<span class="token punctuation">)</span>

	在Docker容器退出时，默认容器内部的文件系统仍然被保留，以方便调试并保留用户数据。
	但是，对于foreground容器，由于其只是在开发调试过程中短期运行，其用户数据并无保留的必要，因而可以在容器启动时设置--rm选项，这样在容器退出时就能够自动清理容器内部的文件系统。示例如下：
	docker run --rm bba-208等价于docker run --rm<span class="token operator">=</span>true bba-208。
	显然，--rm选项不能与-d同时使用，即只能自动清理foreground容器，不能自动清理detached容器
	注意，--rm选项也会清理容器的匿名data volumes。
	所以，执行docker run命令带--rm命令选项，等价于在容器退出后，执行docker <span class="token function">rm</span> -v。


Docker命令详解（run篇）
	命令格式：docker run <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> IMAGE <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> <span class="token punctuation">[</span>ARG<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
	Usage: Run a <span class="token builtin class-name">command</span> <span class="token keyword">in</span> a new container
	中文意思为：通过run命令创建一个新的容器（container）

	常用选项说明
	-d, --detach<span class="token operator">=</span>false， 指定容器运行于前台还是后台，默认为false
	-i, --interactive<span class="token operator">=</span>false， 打开STDIN，用于控制台交互
	-t, --tty<span class="token operator">=</span>false， 分配tty设备，该可以支持终端登录，默认为false
	-u, --user<span class="token operator">=</span><span class="token string">&quot;&quot;</span>， 指定容器的用户
	-a, --attach<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 登录容器（必须是以docker run -d启动的容器）
	-w, --workdir<span class="token operator">=</span><span class="token string">&quot;&quot;</span>， 指定容器的工作目录
	-c, --cpu-shares<span class="token operator">=</span><span class="token number">0</span>， 设置容器CPU权重，在CPU共享场景使用
	-e, --env<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 指定环境变量，容器中可以使用该环境变量
	-m, --memory<span class="token operator">=</span><span class="token string">&quot;&quot;</span>， 指定容器的内存上限
	-P, --publish-all<span class="token operator">=</span>false， 指定容器暴露的端口
	-p, --publish<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 指定容器暴露的端口
	-h, --hostname<span class="token operator">=</span><span class="token string">&quot;&quot;</span>， 指定容器的主机名
	-v, --volume<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 给容器挂载存储卷，挂载到容器的某个目录
	--volumes-from<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 给容器挂载其他容器上的卷，挂载到容器的某个目录
	--cap-add<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 添加权限，权限清单详见：http://linux.die.net/man/7/capabilities
	--cap-drop<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 删除权限，权限清单详见：http://linux.die.net/man/7/capabilities
	--cidfile<span class="token operator">=</span><span class="token string">&quot;&quot;</span>， 运行容器后，在指定文件中写入容器PID值，一种典型的监控系统用法
	--cpuset<span class="token operator">=</span><span class="token string">&quot;&quot;</span>， 设置容器可以使用哪些CPU，此参数可以用来容器独占CPU
	--device<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 添加主机设备给容器，相当于设备直通
	--dns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 指定容器的dns服务器
	--dns-search<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 指定容器的dns搜索域名，写入到容器的/etc/resolv.conf文件
	--entrypoint<span class="token operator">=</span><span class="token string">&quot;&quot;</span>， 覆盖image的入口点
	--env-file<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 指定环境变量文件，文件格式为每行一个环境变量
	--expose<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 指定容器暴露的端口，即修改镜像的暴露端口
	--link<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 指定容器间的关联，使用其他容器的IP、env等信息
	--lxc-conf<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>， 指定容器的配置文件，只有在指定--exec-driver<span class="token operator">=</span>lxc时使用
	--name<span class="token operator">=</span><span class="token string">&quot;&quot;</span>， 指定容器名字，后续可以通过名字进行容器管理，links特性需要使用名字
	--net<span class="token operator">=</span><span class="token string">&quot;bridge&quot;</span>， 容器网络设置:
	bridge 使用docker daemon指定的网桥
	<span class="token function">host</span> //容器使用主机的网络
	container:NAME_or_ID <span class="token operator">&gt;</span>//使用其他容器的网路，共享IP和PORT等网络资源
	none 容器使用自己的网络（类似--net<span class="token operator">=</span>bridge），但是不进行配置
	--privileged<span class="token operator">=</span>false， 指定容器是否为特权容器，特权容器拥有所有的capabilities
	--restart<span class="token operator">=</span><span class="token string">&quot;no&quot;</span>， 指定容器停止后的重启策略:
	no：容器退出时不重启
	on-failure：容器故障退出（返回值非零）时重启
	always：容器退出时总是重启
	--rm<span class="token operator">=</span>false， 指定容器停止后自动删除容器<span class="token punctuation">(</span>不支持以docker run -d启动的容器<span class="token punctuation">)</span>
	--sig-proxy<span class="token operator">=</span>true， 设置由代理接受并处理信号，但是SIGCHLD、SIGSTOP和SIGKILL不能被代理
	示例
	运行一个在后台执行的容器，同时，还能用控制台管理：docker run -i -t -d ubuntu:latest
	运行一个带命令在后台不断执行的容器，不直接展示容器内部信息：docker run -d ubuntu:latest <span class="token function">ping</span> www.docker.com
	运行一个在后台不断执行的容器，同时带有命令，程序被终止后还能重启继续跑，还能用控制台管理，docker run -d --restart<span class="token operator">=</span>always ubuntu:latest <span class="token function">ping</span> www.docker.com
	为容器指定一个名字，docker run -d --name<span class="token operator">=</span>ubuntu_server ubuntu:latest
	容器暴露80端口，并指定宿主机80端口与其通信<span class="token punctuation">(</span>: 之前是宿主机端口，之后是容器需暴露的端口<span class="token punctuation">)</span>，docker run -d --name<span class="token operator">=</span>ubuntu_server -p <span class="token number">80</span>:80 ubuntu:latest
	指定容器内目录与宿主机目录共享<span class="token punctuation">(</span>: 之前是宿主机文件夹，之后是容器需共享的文件夹<span class="token punctuation">)</span>，docker run -d --name<span class="token operator">=</span>ubuntu_server -v /etc/www:/var/www ubuntu:latest
</code></pre></div><h2 id="heroku"><a href="#heroku" aria-hidden="true" class="header-anchor">#</a> Heroku</h2> <blockquote><p>因为 Strapi + postgresql  在 Heroku 上还有一些坑，需要官方解决，这个方案暂时pending</p></blockquote> <hr> <!----></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ly525/luban-h5/edit/master/docs/zh/getting-started/deployment.md" target="_blank" rel="noopener noreferrer">Improve this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/luban-h5/zh/getting-started/code-structure.html" class="prev">
          代码目录说明
        </a></span> <span class="next"><a href="/luban-h5/zh/getting-started/feedback.html">
          Feedback/意见反馈
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/luban-h5/assets/js/app.6a945241.js" defer></script><script src="/luban-h5/assets/js/2.d52d92c6.js" defer></script><script src="/luban-h5/assets/js/8.c0577a36.js" defer></script>
  </body>
</html>
